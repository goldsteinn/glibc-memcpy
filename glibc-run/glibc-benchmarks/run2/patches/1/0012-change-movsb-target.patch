From 0d618432d492dfceca4d102e76a64fd59dc92b73 Mon Sep 17 00:00:00 2001
From: Noah Goldstein <goldstein.w.n@gmail.com>
Date: Sun, 22 Aug 2021 20:53:57 -0400
Subject: [PATCH 12/12] change movsb target

---
 sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S b/sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S
index 035e3533b3..81c369c77d 100644
--- a/sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S
+++ b/sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S
@@ -413,7 +413,7 @@ L(movsb):
 	cmpq	%rdx, %rcx
 	jb	L(more_8x_vec_backward_check_nop)
 	cmp	__x86_rep_movsb_stop_threshold(%rip), %RDX_LP
-    jae L(more_8x_vec)
+	jae	L(large_memcpy_2x_check)
 	VMOVU	(%rsi), %VEC(0)
 # if VEC_SIZE != 64
 	VMOVU	VEC_SIZE(%rsi), %VEC(1)
@@ -482,7 +482,7 @@ L(skip_short_movsb_check):
 	VMOVU	%VEC(1), VEC_SIZE(%r8)
 # endif
 	VZEROUPPER_RETURN
-    .p2align 4,,6
+	.p2align 4,, 6
 #endif
 
 
@@ -530,7 +530,7 @@ L(last_4x_vec):
 	VMOVU	%VEC(3), -(VEC_SIZE * 2)(%rdi, %rdx)
 L(nop):
 	VZEROUPPER_RETURN
-	.p2align 4,,10
+	.p2align 4,, 10
 L(more_8x_vec):
 	/* Check if non-temporal move candidate.  */
 #if (defined USE_MULTIARCH || VEC_SIZE == 16) && IS_IN (libc)
@@ -603,7 +603,7 @@ L(more_8x_vec_backward):
 	leaq	(VEC_SIZE * -4 + -1)(%rdi, %rdx), %rdi
 	andq	$-(VEC_SIZE), %rdi
 	addq	%rdi, %rsi
-	.p2align 4,,11
+	.p2align 4,, 11
 L(loop_4x_vec_backward):
 	VMOVU	(VEC_SIZE * 3)(%rsi), %VEC(0)
 	VMOVU	(VEC_SIZE * 2)(%rsi), %VEC(1)
@@ -631,6 +631,9 @@ L(loop_4x_vec_backward):
 
 #if (defined USE_MULTIARCH || VEC_SIZE == 16) && IS_IN (libc)
 	.p2align 4
+L(large_memcpy_2x_check):
+	cmp	__x86_shared_non_temporal_threshold(%rip), %RDX_LP
+	jb	L(more_8x_vec_forward)
 L(large_memcpy_2x):
 	/* Compute absolute value of difference between source and destination.
 	 */
-- 
2.25.1

