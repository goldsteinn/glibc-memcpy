From 995975f15adb1f86e7e800848b1ccf73428bcf14 Mon Sep 17 00:00:00 2001
From: Noah Goldstein <goldstein.w.n@gmail.com>
Date: Thu, 23 Sep 2021 19:55:46 -0500
Subject: [PATCH 11/11] v1

---
 .../multiarch/memset-vec-unaligned-erms.S     | 60 +++++++++----------
 1 file changed, 27 insertions(+), 33 deletions(-)

diff --git a/sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S b/sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S
index 09aa5cd272..70b38af7e1 100644
--- a/sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S
+++ b/sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S
@@ -181,33 +181,11 @@ ENTRY (MEMSET_SYMBOL (__memset, unaligned_erms))
 	VMOVU	%VEC(0), -VEC_SIZE(%rax, %rdx)
 	VZEROUPPER_RETURN
 #endif
-
-	.p2align 4
-L(loop_4x_vec):
-	leaq	(VEC_SIZE * 4 - LOOP_4X_OFFSET)(%rax), %rcx
-	andq	$-(VEC_SIZE * 2), %rcx
-#if LOOP_4X_OFFSET == 0
-	addq	$-(VEC_SIZE * 4), %rdi
-#endif
-	.p2align 4
-L(loop):
-	VMOVA	%VEC(0), (LOOP_4X_OFFSET)(%rcx)
-	VMOVA	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE)(%rcx)
-	VMOVA	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 2)(%rcx)
-	VMOVA	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 3)(%rcx)
-	subq	$-(VEC_SIZE * 4), %rcx
-	cmpq	%rdi, %rcx
-	jb	L(loop)
-	VMOVU	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 0)(%rdi)
-	VMOVU	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 1)(%rdi)
-	VMOVU	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 2)(%rdi)
-	VMOVU	%VEC(0), (LOOP_4X_OFFSET + VEC_SIZE * 3)(%rdi)
-L(return):
-#if VEC_SIZE > 16
-	ZERO_UPPER_VEC_REGISTERS_RETURN
-#else
-	ret
-#endif
+	.p2align 4,, 10
+L(last_2x_vec):    
+	VMOVU	%VEC(0), (VEC_SIZE * -2)(%rdi)
+	VMOVU	%VEC(0), (VEC_SIZE * -1)(%rdi)
+    VZEROUPPER_RETURN
 
 #if defined USE_MULTIARCH && IS_IN (libc)
 	.p2align 4
@@ -226,16 +204,32 @@ L(more_2x_vec):
 	VMOVU	%VEC(0), (VEC_SIZE * 2)(%rax)
 	VMOVU	%VEC(0), (VEC_SIZE * 3)(%rax)
 	/* Try and have this cmp/jcc on same cache line as target and
-	   fallthrough.  */
-	cmpq	$(VEC_SIZE * 8), %rdx
-	ja	L(loop_4x_vec)
+	fallthrough.  */
+    leaq	(VEC_SIZE * 8)(%rax), %rcx
+	cmpq	%rdi, %rcx
+	jae	L(last_4x_vec)
+    andq    $(VEC_SIZE * -2), %rcx
+	.p2align 4
+L(loop):
+	VMOVA	%VEC(0), (VEC_SIZE * -4)(%rcx)
+	VMOVA	%VEC(0), (VEC_SIZE * -3)(%rcx)
+	VMOVA	%VEC(0), (VEC_SIZE * -2)(%rcx)
+	VMOVA	%VEC(0), (VEC_SIZE * -1)(%rcx)
+	subq	$-(VEC_SIZE * 4), %rcx
+	cmpq	%rdi, %rcx
+	jb	L(loop)
+L(last_4x_vec):    
 	VMOVU	%VEC(0), (VEC_SIZE * -4)(%rdi)
 	VMOVU	%VEC(0), (VEC_SIZE * -3)(%rdi)
-	.p2align 4,, 10
-L(last_2x_vec):    
 	VMOVU	%VEC(0), (VEC_SIZE * -2)(%rdi)
 	VMOVU	%VEC(0), (VEC_SIZE * -1)(%rdi)
-	VZEROUPPER_RETURN
+L(return):
+#if VEC_SIZE > 16
+	ZERO_UPPER_VEC_REGISTERS_RETURN
+#else
+	ret
+#endif
+
 
 
 	.p2align 4,, 10
-- 
2.25.1

