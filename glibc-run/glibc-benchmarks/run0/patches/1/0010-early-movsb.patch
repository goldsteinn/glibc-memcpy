From dd810bca85d6ea49273f99aa57422f210625f578 Mon Sep 17 00:00:00 2001
From: Noah Goldstein <goldstein.w.n@gmail.com>
Date: Sun, 22 Aug 2021 07:25:45 -0400
Subject: [PATCH 10/10] early movsb

---
 sysdeps/x86_64/multiarch/memmove-vec-unaligned.S | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/sysdeps/x86_64/multiarch/memmove-vec-unaligned.S b/sysdeps/x86_64/multiarch/memmove-vec-unaligned.S
index 69de48dbd2..5713a2494b 100644
--- a/sysdeps/x86_64/multiarch/memmove-vec-unaligned.S
+++ b/sysdeps/x86_64/multiarch/memmove-vec-unaligned.S
@@ -397,6 +397,10 @@ L(copy_8_15):
 L(gt_2x):
 #if MOVSB_ALIGN_TO >= (VEC_SIZE * 2)
 	VMOVU	(VEC_SIZE * 1)(%rsi), %VEC(1)
+#endif
+#ifdef USE_WITH_ERMS
+	cmpq	__x86_rep_movsb_threshold(%rip), %rdx
+	ja	L(movsb)
 #endif
 	cmpq	$(VEC_SIZE * 8), %rdx
 	ja	L(gt_8x)
@@ -441,10 +445,7 @@ L(nop):
 	.p2align 4
 L(gt_8x):
 	movq	%rdi, %r8
-#ifdef USE_WITH_ERMS
-	cmpq	__x86_rep_movsb_threshold(%rip), %rdx
-	ja	L(movsb)
-#elif (defined USE_MULTIARCH || VEC_SIZE == 16) && IS_IN (libc)
+#if !defined USE_WITH_ERMS && (defined USE_MULTIARCH || VEC_SIZE == 16) && IS_IN (libc)
 	/* Check non-temporal store threshold.  */
 	cmp	__x86_shared_non_temporal_threshold(%rip), %RDX_LP
 	ja	L(large_memcpy_2x)
@@ -573,6 +574,7 @@ L(loop_4x_backward):
 	.p2align 4
 L(movsb):
 	movq	%rdi, %rcx
+	movq	%rdi, %r8
 	subq	%rsi, %rcx
 	cmpq	%rdx, %rcx
 	jb	L(gt_8x_backward_check_nop)
-- 
2.25.1

